<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Geoportal Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .legend { background: white; padding: 6px; font-size: 12px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const SUPABASE_URL = "https://pzaxjeqmcqcklaflnbdy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6YXhqZXFtY3Fja2xhZmxuYmR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzODMwODMsImV4cCI6MjA2Nzk1OTA4M30.3Y5l7MiNoX0Nebac6Dav8AohmYqTfFhwZGND8RilYmw";

    const layers = [
      'aeropuertos', 'acueducto_l', 'canton', 'casa_p', 'curva_nivel_l',
      'caracteristica_terreno_a', 'parroquias', 'pueblos', 'rio_a', 'poblados',
      'puente_p', 'sendero_l', 'reporte_usuarios', 'via_paltas', 'provincias',
      'vias', 'zona_urbana_a'
    ];

    const map = L.map('map').setView([-3.99, -79.2], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    const layerControl = L.control.layers(null, null, { collapsed: false }).addTo(map);

    async function loadLayer(tableName, color = 'blue') {
      const url = `${SUPABASE_URL}/rest/v1/${tableName}?select=*&apikey=${SUPABASE_KEY}`;
      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
        },
      });

      const data = await res.json();
      if (!data.length) return;

      const geojson = {
        type: "FeatureCollection",
        features: data.map(row => {
          return {
            type: "Feature",
            geometry: row.geometry || row.geom,
            properties: row
          };
        })
      };

      const layer = L.geoJSON(geojson, {
        style: { color },
        onEachFeature: function (feature, layer) {
          let props = feature.properties;
          let popupContent = "<b>" + tableName + "</b><br>" + Object.entries(props).map(([k, v]) => `${k}: ${v}`).join("<br>");
          layer.bindPopup(popupContent);
        }
      });

      layer.addTo(map);
      layerControl.addOverlay(layer, tableName);
    }

    // Colores alternos para diferenciar capas
    const colors = ['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00',
                    '#ffff33','#a65628','#f781bf','#999999','#66c2a5',
                    '#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f',
                    '#e5c494','#b3b3b3'];

    layers.forEach((layerName, i) => {
      loadLayer(layerName, colors[i % colors.length]);
    });
  </script>
</body>
</html>

