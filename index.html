
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Geoportal Clasificaci√≥n de Terreno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; }
    .legend { background: white; padding: 6px; font-size: 12px; }
  </style>
</head>
<body>
  <h3>Clasificaci√≥n de Terreno por Coordenadas UTM (zona 17S)</h3>
  <label>Este (UTM): <input type="number" id="utmE" step="0.001" /></label>
  <label>Norte (UTM): <input type="number" id="utmN" step="0.001" /></label>
  <button onclick="clasificarTerreno()">Clasificar</button>
  <p id="resultado" style="font-weight: bold; color: green;"></p>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


  
  <script src="https://unpkg.com/proj4@2.8.0/dist/proj4.js"></script>

  <script>
    const map = L.map('map').setView([-3.99, -79.2], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let marcador;

    const SUPABASE_URL = 'https://pzaxjeqmcqcklaflnbdy.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6YXhqZXFtY3Fja2xhZmxuYmR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzODMwODMsImV4cCI6MjA2Nzk1OTA4M30.3Y5l7MiNoX0Nebac6Dav8AohmYqTfFhwZGND8RilYmw';
    const supabase = window.supabase;

    async function clasificarTerreno() {
      const utmE = parseFloat(document.getElementById("utmE").value);
      const utmN = parseFloat(document.getElementById("utmN").value);

      if (!utmE || !utmN) {
        alert("Ingrese coordenadas UTM v√°lidas.");
        return;
      }

      const projUTM = "+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs";
      const projWGS84 = "+proj=longlat +datum=WGS84 +no_defs";
      const [lon, lat] = proj4(projUTM, projWGS84, [utmE, utmN]);

      if (marcador) {
        map.removeLayer(marcador);
      }

      marcador = L.marker([lat, lon]).addTo(map).bindPopup("üìç Punto ingresado").openPopup();
      map.setView([lat, lon], 14);

      // Ejecutar funci√≥n SQL en Supabase
      const { data, error } = await supabase.rpc("clasificar_terreno", {
        lat: lat,
        lon: lon
      });

      if (error || !data) {
        document.getElementById("resultado").innerHTML = "‚ö†Ô∏è No se encontr√≥ curva de nivel cercana.";
        return;
      }

      
      // Si 'data' viene como JSON con campos clasificacion y pendiente
      if (typeof data === 'object' && data.clasificacion && data.pendiente) {
        document.getElementById("resultado").innerHTML = `‚úÖ Clasificaci√≥n: ${data.clasificacion}<br>üìê Pendiente: ${data.pendiente.toFixed(2)}‚ÄØ%`;
      } else {
        document.getElementById("resultado").innerHTML = `‚úÖ Clasificaci√≥n: ${data}`;
      }
    

      // Guardar en la tabla
      await supabase.from("clasificacion_terreno").insert([{
        latitud: lat,
        longitud: lon,
        utm_e: utmE,
        utm_n: utmN,
        clasificacion: data
      }]);
    }
  </script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
  import proj4 from 'https://cdn.jsdelivr.net/npm/proj4@2.8.0/+esm'

  const supabaseUrl = 'https://pzaxjeqmcqcklaflnbdy.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6YXhqZXFtY3Fja2xhZmxuYmR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzODMwODMsImV4cCI6MjA2Nzk1OTA4M30.3Y5l7MiNoX0Nebac6Dav8AohmYqTfFhwZGND8RilYmw'
  const supabase = createClient(supabaseUrl, supabaseKey)
  window.supabase = supabase

  const map = L.map('map').setView([-3.99, -79.2], 10)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map)

  let marcador

  window.clasificarTerreno = async function () {
    const utmE = parseFloat(document.getElementById("utmE").value)
    const utmN = parseFloat(document.getElementById("utmN").value)

    if (!utmE || !utmN) {
      alert("Ingrese coordenadas UTM v√°lidas.")
      return
    }

    const projUTM = "+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs"
    const projWGS84 = "+proj=longlat +datum=WGS84 +no_defs"
    const [lon, lat] = proj4(projUTM, projWGS84, [utmE, utmN])

    if (marcador) {
      map.removeLayer(marcador)
    }

    marcador = L.marker([lat, lon]).addTo(map).bindPopup("üìç Punto ingresado").openPopup()
    map.setView([lat, lon], 14)

    const { data, error } = await supabase.rpc("clasificar_terreno", { lat, lon })

    if (error || !data) {
      document.getElementById("resultado").innerHTML = "‚ö†Ô∏è Error al consultar clasificaci√≥n del terreno."
      return
    }

    if (data.clasificacion && data.pendiente !== null) {
      document.getElementById("resultado").innerHTML = `‚úÖ Clasificaci√≥n: ${data.clasificacion}<br>üìê Pendiente: ${data.pendiente}%`
    } else {
      document.getElementById("resultado").innerHTML = `‚ö†Ô∏è ${data.clasificacion}`
    }

    await supabase.from("clasificacion_terreno").insert([{
      latitud: lat,
      longitud: lon,
      utm_e: utmE,
      utm_n: utmN,
      clasificacion: data.clasificacion,
      pendiente: data.pendiente
    }])
  }
</script>

</body>
</html>


